#include "task.hpp"
#include "espressif/esp_common.h"
#include "esp/uart.h"
#include "RCSwitch.h"

#include <string.h>

class task_rf_t: public esp_open_rtos::thread::task_t
{
private:
    void task()
    {
        printf("start rf task\n");

/*
Received 2791937450 / 64 bit, Protocol 8

10347 479 2642 293 1227 294 215 293 1228 293 218 293 1229 291 218 293 218 288 1230 292 1230 292 216 294 1229 292 216 292 1229 292 216 294 219 291 1228 293 218 292 1228 293 1229 291 217 292 1229 290 218 294 1228 293 217 292 216 294 1226 295 1227 293 216 294 217 294 1227 293 1227 293 216 295 1227 293 215 293 1229 292 216 294 217 294 1227 293 1227 293 218 290 218 294 1226 293 1229 293 218 292 1228 293 216 293 218 289 1230 292 1230 291 218 291 220 291 1230 292 216 291 1231 291 220 290 1232 286 1234 287 221 290 1232 289 221 287 1234 286 223 288 1233 
                      1       0        1       0        1       0       0        1        1       0        1       0        1       0       0        1       0        1        1       0        1       0        1       0       0        1        1       0       0        1        1       0        1       0        1       0       0        1        1       0       0        1        1       0        1       0       0        1        1       0       0        1       0        1       1        0        1       0        1       0        1       0        1    0

 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 30
 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 30

bits: 1010100110101001011010100110011010100110011010011001011010101010
      1010100110101001011010100110011010100110011010011001010110101010

should display result: 129 010001000100000101000100010000010001010001000100000101000001010001000100000101000001010001000001010000010001010001000100010001000



off 1

1010100110101001011010100110011010100110011010011001010110101010
details 33 314 188
received
Received 2791937450 / 64 bit, Protocol 8

10377 787 2644 300 1226 299 210 299 1226 298 214 298 1228 298 211 298 215 294 1229 297 1228 297 215 298 1227 297 212 297 1229 297 212 298 216 297 1227 296 215 298 1226 298 1227 297 216 296 1228 294 215 298 1228 296 216 293 216 297 1229 296 1227 297 214 297 215 297 1227 297 1228 297 213 298 1228 297 212 298 1229 296 213 297 216 297 1227 296 1229 297 215 294 216 296 1228 296 1229 296 216 297 1228 296 214 297 216 293 1229 296 1230 297 213 295 218 296 1229 294 215 294 1232 293 218 294 1231 290 1235 290 220 292 1232 293 220 289 1236 288 221 290 1236



*/
        RCSwitch mySwitch = RCSwitch();
        mySwitch.enableTransmit(4); // d2
        mySwitch.setProtocol(1);
        printf("send\n");
        mySwitch.setPulseLength(180);
        mySwitch.send(284099, 24); // on 2
        printf("\nend to send\n");

        // mySwitch.setProtocol(8);
        // printf("Start to send:\n");
        // mySwitch.send("1010100110101001011010100110011010100110011010011001010110101010");
        // printf("\nend to send\n");


// MHB
// 275 9900 275 2675 275 1225 275 275 275 1225 275 275 275 1225 275  275 275  275 275 1225 275 1225 275  275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275  275 275 1225 275 1225 275  275 275 1225 275  275 275 1225 275  275 275  275 275 1225 275 1225 275 275 275  275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 275 275 1225 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 1225
// sent 64  300 2700 300 1200 300 300 300 1200 300 300 300  300 300 1200 300 1200 300  300 300  300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300  300 300  300 300 1200 300  300 300 1200 300  300 300 1200 300 1200 300  300 300 1200 300 300 300 1200 300  300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900
// send 63  300 2700 300  300 300 1200 300 300 300 300 300 1200 300 1200 300  300 300  300 300 1200 300 1200 300  300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 9900 
//          300 2700 300 1200 300 300 300 1200 300 300 300 1200 300  300 300  300 300 1200 300 1200 300 300  300 1200 300 300 300 1200 300 300 300 120 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 9900
//R-> 10371 455 2642 302 1223 302 209 301 1225 301 211 302 1224 300  211 300  212 298 1226 300 1226 299  213 300 1226 299 210 300 1227 298 212 299 215 299 1225 299  213 299 1226 298 1227 299  213 296 1230 295  215 298 1227 299  214 295  215 299 1226 298 1227 298 213 300 213 299  1226 298 1227 299 212 299 1227 298 212 299 1226 299 212 299 215 298 1226 298 1227 298 215 295 214 299 1226 299 1227 298 214 298 1228 297 213 298 214 296 1228 298 1227 297 214 298 215 298 1227 297 214 296 1229 297 216 296 1229 293 1232 292 218 295 1230 295 217 292 1233 292 219 294 1235 
//                          1       0        1       0        1        0        0        1        1        0        1       0        1       0       0        1        0        1        1        0        1        0        1        0        0        1        1       0        0        1        1       0        1       0        1       0       0        1        1       0       0        1        1       0        1       0       0        1        1       0       0        1       0        1       0        1        1       0        1       0        1       0        1

// 10371 455 2642 302 1223 302 209 301 1225 301 211 302 1224 300 211 300 212 298 1226 300 1226 299 213 300 1226 299 210 300 1227 298 212 299 215 299 1225 299 213 299 1226 298 1227 299 213 296 1230 295 215 298 1227 299 214 295 215 299 1226 298 1227 298 213 300 213 299 1226 298 1227 299 212 299 1227 298 212 299 1226 299 212 299 215 298 1226 298 1227 298 215 295 214 299 1226 299 1227 298 214 298 1228 297 213 298 214 296 1228 298 1227 297 214 298 215 298 1227 297 214 296 1229 297 216 296 1229 293 1232 292 218 295 1230 295 217 292 1233 292 219 294 1235
//       300 2700 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 9900


//                       1       0        1       0        1       0       0        1        1       0        1       0        1       0       0        1       0        1        1       0        1       0        1       0       0        1        1       0       0        1        1       0        1       0        1       0       0        1        1       0       0        1        1       0        1       0       0        1        1       0       0        1       0        1       0        1        1       0        1       0        1       0        1       0       
//  9900 300 2700 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 1200 300 9900 300 2700 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 300 300 1200 300 1200 300 300 300 1200 300 300 300 1200 300 300 300 300 300 1200 300 1200 300 300 300 
//  9900 275 2675 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 275 275 1225 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 1225 275 9900 275 2675 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 275 275 1225 275 1225 275 275 275 1225 275 275 275 1225 275 275 275 275 275 


// 5667 270 512 224 510 224 512 224 512 222 512 591 144 223 516 219 514 223 512 590 147 220 515 589 147 220 516 587 149 219 519 584 149 586 150 586 154 213 520 215 521 216 519 215 524 579 155 580 155 
//            0       0       0       0       0       1       0       0       0       1       0       1       0       1       0       1       1       1       0       0       0       0       1       1
// Received 284099 / 24 bit, Protocol 1
// 000001000101010111000011 <- calculated
// 000001000101010111000011 <- printed
// 000001000101010111001100



        mySwitch.enableReceive(12);  // wemos mini d6

        while(true) {
            if (mySwitch.available()) {
                printf("received\n");
                int value = mySwitch.getReceivedValue();
                
                if (value == 0) {
                    printf("Unknown encoding\n");
                } else {
                    unsigned int * timings = mySwitch.getReceivedRawdata();
                    unsigned int changeCount = mySwitch.getReceivedBitlength()*2 + 1;
                    for(unsigned int o = 0; o < changeCount; o++) {
                        printf("%d ", timings[o]);
                    }            
                    printf("\nReceived %lu", mySwitch.getReceivedValue());
                    printf(" / %d bit, Protocol %d\n", mySwitch.getReceivedBitlength(), mySwitch.getReceivedProtocol());
                }

                mySwitch.resetAvailable();
            }  
        }      
    }    
};

task_rf_t task_rf;

extern "C" void user_init(void)
{
    uart_set_baud(0, 115200);
    task_rf.task_create("task_rf");
}
